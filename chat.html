<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>1:1 Live Chat</title>
  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial; background: #f2f2f2; padding: 20px; }
    .login-container, .chat-container { background: #fff; padding: 20px; border-radius: 10px; max-width: 400px; margin: auto; }
    input { display: block; margin: 10px 0; padding: 10px; width: 100%; }
    button { padding: 10px; margin: 5px 0; width: 100%; cursor: pointer; }
    #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
    .message { margin: 5px 0; }
  </style>
</head>
<body>
  <!-- Login / Signup -->
  <div class="login-container">
    <h2>Login / Signup</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Login</button>
  </div>

  <!-- Chat Container -->
  <div class="chat-container" style="display:none;">
    <h2>1:1 Live Chat</h2>
    <input type="text" id="receiver" placeholder="Receiver Email">
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

    // ðŸ”¹ Replace this with your existing Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBbPeczqOSEKmW3W8p-AiQvvbWz6o5qc98",
      authDomain: "suvidha-e1d61.firebaseapp.com",
      projectId: "suvidha-e1d61",
      storageBucket: "suvidha-e1d61.appspot.com",
      messagingSenderId: "179187721856",
      appId: "1:179187721856:web:cf6d935367c5ff889b6865"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const loginContainer = document.querySelector(".login-container");
    const chatContainer = document.querySelector(".chat-container");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const receiverInput = document.getElementById("receiver");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");

    // Signup
    document.getElementById("signupBtn").onclick = async () => {
      try {
        await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        alert("Signup successful!");
      } catch(e){ alert(e.message); }
    };

    // Login
    document.getElementById("loginBtn").onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      } catch(e){ alert(e.message); }
    };

    // Logout
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
    };

    // After login
    onAuthStateChanged(auth, user => {
      if(user){
        loginContainer.style.display = "none";
        chatContainer.style.display = "block";

        // Load messages in real-time
        onSnapshot(query(collection(db, "messages"), orderBy("timestamp")), snapshot => {
          messagesDiv.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            // Show only messages sent or received by this user + receiver
            if((data.user === user.email && data.receiver === receiverInput.value) ||
               (data.user === receiverInput.value && data.receiver === user.email)) {
              const div = document.createElement("div");
              div.className = "message";
              div.innerHTML = `<b>${data.user}:</b> ${data.text}`;
              messagesDiv.appendChild(div);
            }
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

      } else {
        loginContainer.style.display = "block";
        chatContainer.style.display = "none";
      }
    });

    // Send message
    document.getElementById("sendBtn").onclick = async () => {
      if(!messageInput.value || !receiverInput.value) return;
      await addDoc(collection(db, "messages"), {
        text: messageInput.value,
        user: auth.currentUser.email,
        receiver: receiverInput.value,
        timestamp: serverTimestamp()
      });
      messageInput.value = "";
    };
  </script>
</body>
</html>
